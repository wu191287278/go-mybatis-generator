<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link href="./js/cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="./js/bootstrap-treeview.min.css" rel="stylesheet">
    <style type="text/css">
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
<section style="height: 50px;">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                        data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="javascript:void(0)">Mybatis Processor Generator</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <div class="navbar-form navbar-right">
                    <div class="form-group">
                        <select id="selectTemplate" onchange="changeTemplate()" class="form-control">
                            <option value="settingTemplateDiv">Sql</option>
                            <option value="queryTemplateDiv">Repository</option>
                            <option value="controllerTemplateDiv">Controller</option>
                            <option value="serviceTemplateDiv">Service</option>
                            <option value="modelTemplateDiv">Domain</option>
                            <option value="queryTemplateDiv">Query</option>
                            <option value="applicationTemplateDiv">Main</option>
                            <option value="pomTemplateDiv">GoMod</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-default" onclick="clearCache()">Reset</button>
                    <!--                    <button type="button" class="btn btn-default" onclick="save()">Save</button>-->
                    <button type="button" class="btn btn-default" onclick="generatorSpringBootPop()">Generate
                    </button>
                </div>

            </div>
        </div>
    </nav>
</section>
<div class="row" style="height: 100%">

    <div class="col-xs-12" style="height: 100%;padding-top: 10px" id="settingTemplateDiv">
        <div id="settingTemplate" style="width:100%;height:100%"></div>
    </div>
    <div class="col-xs-12" style="height: 100%;padding-top: 10px" id="queryTemplateDiv">
        <div id="queryTemplate" style="width:100%;height:100%"></div>
    </div>
    <div class="col-xs-12" style="height: 100%;padding-top: 10px" id="controllerTemplateDiv">
        <div id="controllerTemplate" style="width:100%;height:100%"></div>
    </div>
    <div class="col-xs-12" style="height: 100%;padding-top: 10px" id="applicationTemplateDiv">
        <div id="applicationTemplate" style="width:100%;height:100%"></div>
    </div>
    <div class="col-xs-12" style="height: 100%;padding-top: 10px" id="queryTemplateDiv">
        <div id="configTemplate" style="width:100%;height:100%"></div>
    </div>
    <div class="col-xs-12" style="height: 100%;padding-top: 10px" id="pomTemplateDiv">
        <div id="pomTemplate" style="width:100%;height:100%"></div>
    </div>
    <div class="col-xs-12" style="height: 100%;padding-top: 10px" id="modelTemplateDiv">
        <div id="modelTemplate" style="width:100%;height:100%"></div>
    </div>
    <div class="col-xs-12" style="height: 100%;padding-top: 10px" id="serviceTemplateDiv">
        <div id="serviceTemplate" style="width:100%;height:100%"></div>
    </div>
</div>
<div class='modal' id='generatorSpringBootPop'>
    <div class='modal-dialog'>
        <div class='modal-content'>
            <div class='modal-header'>
                <button type='button' class='close' data-dismiss='modal'>
                    <span aria-hidden='true'>×</span><span class='sr-only'>Close</span>
                </button>
                <h4 class='modal-title'>Generate SpringBoot Project</h4>
            </div>
            <div class='modal-body'>
                <form onsubmit="generate()" action="javascript:void(0)" method="get" role='form'>
                    <div class='form-group'>
                        <label>Artifact:</label>
                        <input type='text' class='form-control' id="artifact" value="demo" placeholder="demo">
                    </div>
                    <div class='form-group' style="display: none">
                        <label>Group ID:</label>
                        <input type='text' class='form-control' id="packagePath" value=""
                               placeholder="">
                    </div>
                    <div class='form-group'>
                        <label>Trim Prefix:</label>
                        <input type='text' class='form-control' id="trimPrefix" value="tb_,t_"
                               placeholder="tb_">
                    </div>
                    <div class='form-group'>
                        <label>Add Prefix:</label>
                        <input type='text' class='form-control' id="addPrefix" value=""
                               placeholder="Prefix">
                    </div>
                    <div class='form-group'>
                        <label>Add Suffix:</label>
                        <input type='text' class='form-control' id="addSuffix" value=""
                               placeholder="Suffix">
                    </div>
                    <div class='modal-footer'>
                        <button type="button" onclick="generatorSpringBootView()" class='btn btn-primary'>Preview
                        </button>
                        <button type="submit" class='btn btn-success'>Download</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class='modal' id='generatorSpringBootView' style="width: 100%;height: 900px;overflow: hidden;">
    <div class='modal-dialog modal-lg' style="width: 100%;height: 900px">
        <div class='modal-content'>
            <div class='modal-header'>
                <button type='button' class='close' data-dismiss='modal'>
                    <span aria-hidden='true'>×</span><span class='sr-only'>Close</span>
                </button>
                <h4 class='modal-title' id="codePreview">Preview</h4>
            </div>
            <div class='modal-body'>
                <div class="row">
                    <div class="col-lg-4" style="height: 800px;overflow: auto">
                        <div id="treeview"></div>
                    </div>
                    <div class="col-lg-8">
                        <div id="treeCode" style="width:100%;height:800px"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<script type="text/javascript" src="./js/jszip-utils.min.js"></script>
<script src="./js/cdn.bootcdn.net/ajax/libs/mustache.js/3.0.1/mustache.min.js"></script>
<script src="./js/cdn.bootcdn.net/ajax/libs/FileSaver.js/2014-11-29/FileSaver.js"></script>
<script src="./js/cdn.bootcdn.net/ajax/libs/jszip/3.1.5/jszip.js"></script>
<script src="./js/cdn.bootcdn.net/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
<script src="./js/cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="./js/bootstrap-treeview.min.js"></script>
<script src="./js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/loader.js"></script>
<script>
    let settingsEditor;
    let repositoryTemplate;
    let controllerTemplate;
    let queryTemplate;
    let pomTemplate;
    let applicationTemplate;
    let modelTemplate;
    let serviceTemplate;
    let treeTemplate;
    let configTemplate;


    function loadSettingsEditor(settings) {
        require.config({paths: {'vs': './js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/'}});
        if (settingsEditor) {
            require(['vs/editor/editor.main'], function () {
                let model = settingsEditor.getModel()
                model.setValue(settings)
            });
        } else {
            let container = document.getElementById('settingTemplate');
            let defaultOption = {
                value: settings,
                language: 'sql'
            };
            require(['vs/editor/editor.main'], function () {
                settingsEditor = monaco.editor.create(container, defaultOption);

                window.onresize = function () {
                    settingsEditor.layout();
                };
            });
        }
    }

    function loadRepositoryTemplateEditor(template) {
        require.config({paths: {'vs': './js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/'}});
        if (repositoryTemplate) {
            require(['vs/editor/editor.main'], function () {
                let model = repositoryTemplate.getModel()
                model.setValue(template)
            });
        } else {
            let container = document.getElementById('queryTemplate');
            let defaultOption = {
                value: template,
                language: 'go'
            };
            require(['vs/editor/editor.main'], function () {
                repositoryTemplate = monaco.editor.create(container, defaultOption);

                window.onresize = function () {
                    repositoryTemplate.layout();
                };
            });
        }
    }

    function loadControllerTemplateEditor(template) {
        if (controllerTemplate) {
            require(['vs/editor/editor.main'], function () {
                let model = controllerTemplate.getModel()
                model.setValue(template)
            });
        } else {
            let container = document.getElementById('controllerTemplate');
            let defaultOption = {
                value: template,
                language: 'go'
            };
            require.config({paths: {'vs': './js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/'}});
            require(['vs/editor/editor.main'], function () {
                controllerTemplate = monaco.editor.create(container, defaultOption);

                window.onresize = function () {
                    controllerTemplate.layout();
                };
            });
        }
    }

    function loadTreeTemplateEditor(template) {
        if (treeTemplate) {
            require(['vs/editor/editor.main'], function () {
                let model = treeTemplate.getModel()
                model.setValue(template)
            });
        } else {
            let container = document.getElementById('treeCode');
            let defaultOption = {
                value: template,
                language: 'go'
            };
            require.config({paths: {'vs': './js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/'}});
            require(['vs/editor/editor.main'], function () {
                treeTemplate = monaco.editor.create(container, defaultOption);

                window.onresize = function () {
                    treeTemplate.layout();
                };
            });
        }
    }

    function loadQueryTemplateEditor(template) {
        if (queryTemplate) {
            require(['vs/editor/editor.main'], function () {
                let model = queryTemplate.getModel()
                model.setValue(template)
            });
        } else {
            let container = document.getElementById('configTemplate');
            let defaultOption = {
                value: template,
                language: 'go'
            };
            require.config({paths: {'vs': './js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/'}});
            require(['vs/editor/editor.main'], function () {
                queryTemplate = monaco.editor.create(container, defaultOption);

                window.onresize = function () {
                    queryTemplate.layout();
                };
            });
        }
    }

    function loadApplicationTemplateEditor(template) {
        if (applicationTemplate) {
            require(['vs/editor/editor.main'], function () {
                let model = applicationTemplate.getModel()
                model.setValue(template)
            });
        } else {
            let container = document.getElementById('applicationTemplate');
            let defaultOption = {
                value: template,
                language: 'go'
            };
            require.config({paths: {'vs': './js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/'}});
            require(['vs/editor/editor.main'], function () {
                applicationTemplate = monaco.editor.create(container, defaultOption);

                window.onresize = function () {
                    applicationTemplate.layout();
                };
            });
        }
    }


    function loadPomTemplateEditor(template) {
        if (pomTemplate) {
            require(['vs/editor/editor.main'], function () {
                let model = pomTemplate.getModel()
                model.setValue(template)
            });
        } else {
            let container = document.getElementById('pomTemplate');
            let defaultOption = {
                value: template,
                language: 'xml'
            };
            require.config({paths: {'vs': './js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/'}});
            require(['vs/editor/editor.main'], function () {
                pomTemplate = monaco.editor.create(container, defaultOption);

                window.onresize = function () {
                    pomTemplate.layout();
                };
            });
        }
    }

    function loadModelTemplateEditor(template) {
        if (modelTemplate) {
            require(['vs/editor/editor.main'], function () {
                let model = modelTemplate.getModel()
                model.setValue(template)
            });
        } else {
            let container = document.getElementById('modelTemplate');
            let defaultOption = {
                value: template,
                language: 'go'
            };
            require.config({paths: {'vs': './js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/'}});
            require(['vs/editor/editor.main'], function () {
                modelTemplate = monaco.editor.create(container, defaultOption);

                window.onresize = function () {
                    pomTemplate.layout();
                };
            });
        }
    }

    function loadServiceTemplateEditor(template) {
        if (serviceTemplate) {
            require(['vs/editor/editor.main'], function () {
                let model = serviceTemplate.getModel()
                model.setValue(template)
            });
        } else {
            let container = document.getElementById('serviceTemplate');
            let defaultOption = {
                value: template,
                language: 'go'
            };
            require.config({paths: {'vs': './js/cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/'}});
            require(['vs/editor/editor.main'], function () {
                serviceTemplate = monaco.editor.create(container, defaultOption);

                window.onresize = function () {
                    pomTemplate.layout();
                };
            });
        }
    }


    async function generate() {
        let packagePath = document.getElementById("packagePath").value;
        let artifact = document.getElementById("artifact").value;
        let trimPrefix = document.getElementById("trimPrefix").value;
        let addPrefix = document.getElementById("addPrefix").value;
        let addSuffix = document.getElementById("addSuffix").value;
        let zip = new JSZip();

        let settings = settingsEditor.getValue().split(";");
        for (let setting in settings) {
            let sql = settings[setting].trim();
            if (sql === "") {
                continue;
            }
            if (!sql.trim().toUpperCase().startsWith("CREATE")) {
                continue;
            }
            let tableDefine = getFields(sql, trimPrefix, addPrefix, addSuffix);
            tableDefine.artifact = artifact;
            tableDefine.application = upperCamel(artifact);
            tableDefine.packagePath = packagePath;
            tableDefine.packageDir = packagePath.replaceAll(".", "/");
            let index = tableDefine
            let value = repositoryTemplate.getValue();
            let render = Mustache.render(value, index);
            let query = "repository/" + index["modelName"] + "_repository.go";
            // let query = artifact + "/src/main/java/" + packagePath.replace(/[.]/g, "/") + "/repository/" + index["modelName"] + "Repository.java";
            zip.file(query, render);

            value = controllerTemplate.getValue();
            render = Mustache.render(value, index);
            let controller = "controller/" + index["modelName"] + "_controller.go";
            zip.file(controller, render);

            value = serviceTemplate.getValue();
            render = Mustache.render(value, index);
            let service = "service/" + index["modelName"] + "_service.go";
            zip.file(service, render);

            value = modelTemplate.getValue();
            let modelName = tableDefine["modelName"];
            render = Mustache.render(value, index);
            let model = "domain/" + modelName + ".go";
            console.log(render);
            zip.file(model, render);

            value = queryTemplate.getValue();
            let queryName = tableDefine["modelName"];
            render = Mustache.render(value, index);
            let queryModel = "domain/" + queryName + "_example.go";
            console.log(render);
            zip.file(queryModel, render);

            zip.file("config.toml", configTemplate);
        }

        let project = {
            "packagePath": packagePath,
            "artifact": artifact,
            packageDir: packagePath.replaceAll(".", "/")
        };

        zip.file("go.mod", Mustache.render(pomTemplate.getValue(), project));
        zip.file("main.go", Mustache.render(applicationTemplate.getValue(), project));
        zip.generateAsync({type: "blob"})
            .then(function (content) {
                saveAs(content, artifact + ".zip");
            });

    }

    function getFields(value, trimPrefix, addPrefix, addSuffix) {
        let start = value.indexOf("(");
        let end = value.lastIndexOf(")");
        let tableSplit = value.split(/\s+/g);
        console.log(tableSplit);

        let tableComment = "";
        if (tableSplit[tableSplit.length - 1].indexOf("COMMENT=") !== -1) {
            tableComment = tableSplit[tableSplit.length - 1]
                .replaceAll("COMMENT=", "")
                .replaceAll("';", "")
                .replaceAll("'", "");
        }
        let tableName = tableSplit[2]
            .replaceAll("`", "");

        let modelName = tableName;
        let domainName = upperCamel(tableName);
        if (trimPrefix) {
            let subTableName = tableName;
            let trimPrefixSplit = trimPrefix.split(",");
            for (let i = 0; i < trimPrefixSplit.length; i++) {
                let trimIte = trimPrefixSplit[i].trim();
                if (subTableName.startsWith(trimIte)) {
                    subTableName = subTableName.substring(trimIte.length)
                    modelName = subTableName;
                    domainName = upperCamel(subTableName);
                    break;
                }
            }
        }
        if (addPrefix) {
            modelName = addPrefix + modelName;
        }
        if (addSuffix) {
            modelName = modelName + addSuffix;
        }

        let columnsDe = value.substring(start + 1, end);

        let primaryKeyColumn = "";
        let fields = [];
        let tableDef = {
            tableComment: tableComment,
            modelName: modelName,
            domainName: domainName,
            lowerModelName: modelName.substring(0, 1).toLowerCase() + modelName.substring(1),
            lowerDomainName: domainName.substring(0, 1).toLowerCase() + domainName.substring(1),
            tableName: tableName,
            fields: fields
        }

        let columnSplit = columnsDe.split(",\n");
        if (columnSplit.length === 1) {
            columnSplit = columnsDe.split(",");
        }
        for (let i = 0; i < columnSplit.length; i++) {
            let columnDe = columnSplit[i];
            console.log(columnDe)
            let split = columnDe.trim().split(/\s+/g);
            if ((split[0] + " " + split[1]).toUpperCase().indexOf("PRIMARY KEY") !== -1) {
                primaryKeyColumn = split[2].replaceAll("(", "")
                    .replaceAll(")", "")
                    .replaceAll("`", "")
                    .replaceAll("\"", "");
                break;
            }

            if (split[0].toUpperCase() === "KEY") {
                continue;
            }

            let columnName = split[0]
                .replaceAll("\"", "")
                .replaceAll("`", "");
            if (/^[0-9]+.?[0-9]*/.test(columnName.substring(0, 1))) {
                segment = columnDe;
                continue;
            }

            let columnType = split[1];
            let columnScale = 0;
            let columnLength = 0;
            let columnComment = "";
            let notNull = columnDe.toUpperCase().indexOf("NOT NULL") !== -1;
            let autoIncrement = columnDe.toUpperCase().indexOf("AUTO_INCREMENT") !== -1;
            if (columnDe.indexOf("COMMENT") !== -1) {
                columnComment = columnDe.substring(columnDe.indexOf("COMMENT") + 7, columnDe.lastIndexOf("'"))
            }
            if (columnType.indexOf("(") !== -1) {
                let lengths = columnType.split("(")[1];
                lengths = lengths.substring(0, lengths.indexOf(")"));
                let lengthSplit = lengths.split(",");
                columnLength = lengthSplit[0];
                if (lengthSplit.length > 0) {
                    columnScale = lengthSplit[1];
                }
                columnType = columnType.substring(0, columnType.indexOf("("));
            } else {
                columnLength = getDefaultLength(columnType);
            }

            let fieldName = convertToCamelCase(columnName);
            let fieldType = getType(columnType);

            let filed = {
                columnName: columnName,
                columnType: columnType.toUpperCase(),
                fieldType: fieldType,
                fieldName: fieldName,
                autoIncrement: autoIncrement,
                firstUpFieldName: fieldName.substring(0, 1).toUpperCase() + fieldName.substring(1),
                notNull: notNull,
            }


            if (columnLength > 0) {
                if (columnLength !== "255") {
                    filed.columnLength = columnLength;
                }
            }

            if (columnScale > 0) {
                filed.columnScale = columnScale;
            }
            if (columnComment !== "") {
                filed.columnComment = columnComment
                    .replaceAll("'", "");
            }

            console.log(filed);
            fields.push(filed);
        }
        processFields(fields);
        tableDef.primaryKeys = []
        for (let i = 0; i < fields.length; i++) {
            if (fields[i].columnName === primaryKeyColumn) {
                fields[i].primaryKey = true;
                tableDef.hasPrimaryKey = true;
                tableDef.primaryKeys.push(fields[i]);
            }
        }
        if (tableDef.primaryKeys.length === 0) {
            tableDef.hasPrimaryKey = true;
            tableDef.primaryField = tableDef.fields[0];
            tableDef.primaryKeys.push(tableDef.fields[0]);
        }

        console.log(tableDef)

        function convertToCamelCase(str) {
            return str.toLowerCase().replace(/_(.)/g, function (match, group1) {
                return group1.toUpperCase();
            });
        }


        function getJavaType(columnType) {
            columnType = columnType.toUpperCase();
            const DEFAULT_TYPE_MAPPING = {
                "BIGINT": "Long",
                "INT": "Integer",
                "INTEGER": "Integer",
                "SMALLINT": "Short",
                "TINYINT": "Byte",
                "DECIMAL": "java.math.BigDecimal",
                "MEDIUMINT": "java.math.BigInteger",
                "NUMERIC": "java.math.BigInteger",
                "DOUBLE": "Double",
                "FLOAT": "Float",
                "GEOM": "Float",
                "TIMESTAMP": "java.util.Date",
                "TIME": "java.util.Date",
                "DATE": "java.util.Date",
                "DATETIME": "java.util.Date",
                "DATETIME": "java.util.Date",
                "TEXT": "String",
                "TINYTEXT": "String",
                "VARCHAR": "String",
                "CHAR": "String",
                "ENUM": "String",
                "JSON": "String",
                "LINESTRING": "String",
                "BLOB": "Byte[]",
                "TINYBLOB": "Byte[]",
                "MEDIUMBLOB": "Byte[]",
                "BINARY": "Byte[]",
                "BIT": "Boolean",
            };
            if (DEFAULT_TYPE_MAPPING[columnType]) {
                return DEFAULT_TYPE_MAPPING[columnType];
            }
            return "String";
        }

        function getDefaultLength(columnType, columnLength) {
            columnType = columnType.toUpperCase();
            let DEFAULT_LENGTH_MAPPING = {}

            if (columnLength > 0) {
                return columnLength;
            }
            return DEFAULT_LENGTH_MAPPING[columnType] ? DEFAULT_LENGTH_MAPPING[columnType] : 0;
        }

        return tableDef;
    }


    function lowerCamel(name) {
        return name.replace(/[^a-zA-Z0-9]/g, "_").replace(/_([a-z0-9_A-Z])/g, function (all, letter) {
            return letter.toUpperCase();
        });
    }

    function upperCamel(name) {
        let lower = lowerCamel(name);
        if (lower.length > 1) {
            return lower.substr(0, 1).toUpperCase() + lower.substr(1, lower.length - 1);
        }
        return lower.toUpperCase();
    }

    function toLine(name) {
        return name.replace(/([A-Z])/g, "_$1").toLowerCase();
    }

    let typeMapping = {
        "string": "String",
        "keyword": "String",
        "text": "String",
        "ip": "String",
        "range": "String",
        "completion": "String",
        "object": "java.util.Map<String,Object>",
        "nested": "java.util.Map<String,Object>",
        "geo_point": "Double[]",
        "geo_shape": "Double[]",
        "long": "Long",
        "token_count": "Long",
        "integer": "Integer",
        "short": "Short",
        "byte": "Byte",
        "double": "Double",
        "float": "Float",
        "half_float": "Float",
        "scaled_float": "Float",
        "date": "java.util.Date",
        "boolean": "Boolean",
        "binary": "Byte[]",
        "attachment": "Byte[]",
    };

    function loadingSettings() {
        let storage = window.localStorage;
        let settings = storage.getItem("es.settings");
        if (settings) {
            loadSettingsEditor(settings);
        } else {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status === 200) {
                    loadSettingsEditor(xhr.responseText);
                } else {
                    alert(xhr.status);
                }
            };

            xhr.open("get", "./template/example.sql");
            xhr.send(null);
        }
    }


    function loadingRepositoryEditor() {
        let storage = window.localStorage;
        let template = storage.getItem("es.queryTemplate");
        if (template) {
            loadRepositoryTemplateEditor(template);
        } else {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status === 200) {
                    loadRepositoryTemplateEditor(xhr.responseText);
                } else {
                    alert(xhr.status);
                }
            };

            xhr.open("get", "./template/repository.mustache");
            xhr.send(null);
        }
    }

    function loadingControllerEditor() {
        let storage = window.localStorage;
        let template = storage.getItem("es.controllerTemplate");
        if (template) {
            loadControllerTemplateEditor(template);
        } else {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status === 200) {
                    loadControllerTemplateEditor(xhr.responseText);
                } else {
                    alert(xhr.status);
                }
            };

            xhr.open("get", "./template/controller.mustache");
            xhr.send(null);
        }
    }


    function loadingPomEditor() {
        let storage = window.localStorage;
        let template = storage.getItem("es.pomTemplate");
        if (template) {
            loadPomTemplateEditor(template);
        } else {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status === 200) {
                    loadPomTemplateEditor(xhr.responseText);
                } else {
                    alert(xhr.status);
                }
            };

            xhr.open("get", "./template/go.mod");
            xhr.send(null);
        }
    }


    function loadingQueryEditor() {
        let storage = window.localStorage;
        let template = storage.getItem("es.configTemplate");
        if (template) {
            loadQueryTemplateEditor(template);
        } else {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status === 200) {
                    loadQueryTemplateEditor(xhr.responseText);
                } else {
                    alert(xhr.status);
                }
            };

            xhr.open("get", "./template/query.mustache");
            xhr.send(null);
        }
    }


    function loadingApplicationEditor() {
        let storage = window.localStorage;
        let template = storage.getItem("es.applicationTemplate");
        if (template) {
            loadApplicationTemplateEditor(template);
        } else {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status === 200) {
                    loadApplicationTemplateEditor(xhr.responseText);
                } else {
                    alert(xhr.status);
                }
            };

            xhr.open("get", "./template/application.mustache");
            xhr.send(null);
        }
    }


    function loadingModelEditor() {
        let storage = window.localStorage;
        let template = storage.getItem("es.modelTemplate");
        if (template) {
            loadModelTemplateEditor(template);
        } else {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status === 200) {
                    loadModelTemplateEditor(xhr.responseText);
                } else {
                    alert(xhr.status);
                }
            };

            xhr.open("get", "./template/domain.mustache");
            xhr.send(null);
        }
    }

    function loadToml() {
        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            if (xhr.status === 200) {
                configTemplate = xhr.responseText;
            } else {
                alert(xhr.status);
            }
        };

        xhr.open("get", "./template/config.toml");
        xhr.send(null);
    }

    function loadingServiceEditor() {
        let storage = window.localStorage;
        let template = storage.getItem("es.serviceTemplate");
        if (template) {
            loadServiceTemplateEditor(template);
        } else {
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status === 200) {
                    loadServiceTemplateEditor(xhr.responseText);
                } else {
                    alert(xhr.status);
                }
            };

            xhr.open("get", "./template/service.mustache");
            xhr.send(null);
        }
    }


    loadingSettings();
    loadingRepositoryEditor();
    loadingControllerEditor();
    loadingQueryEditor();
    loadingApplicationEditor();
    loadingPomEditor();
    loadingModelEditor();
    loadingServiceEditor();
    loadToml();

    function clearCache() {
        let storage = window.localStorage;
        storage.removeItem("es.settings");
        storage.removeItem("es.queryTemplate");
        storage.removeItem("es.controllerTemplate");
        storage.removeItem("es.configTemplate");
        storage.removeItem("es.pomTemplate");
        storage.removeItem("es.applicationTemplate");
        storage.removeItem("es.modelTemplate");
        storage.removeItem("es.serviceTemplate");
        window.location.reload()
    }

    function save() {
        let storage = window.localStorage;
        storage.setItem("es.settings", settingsEditor.getValue());
        storage.setItem("es.queryTemplate", repositoryTemplate.getValue());
        storage.setItem("es.controllerTemplate", controllerTemplate.getValue());
        storage.setItem("es.configTemplate", queryTemplate.getValue());
        storage.setItem("es.pomTemplate", pomTemplate.getValue());
        storage.setItem("es.applicationTemplate", applicationTemplate.getValue());
        storage.setItem("es.modelTemplate", modelTemplate.getValue());
        storage.setItem("es.serviceTemplate", modelTemplate.getValue());
        alert("success")
    }

    function changeTemplate() {
        hiddenTemplate();
        document.getElementById(document.getElementById("selectTemplate").value).hidden = false;
    }

    function hiddenTemplate() {
        document.getElementById("settingTemplateDiv").hidden = true;
        document.getElementById("queryTemplateDiv").hidden = true;
        document.getElementById("controllerTemplateDiv").hidden = true;
        document.getElementById("queryTemplateDiv").hidden = true;
        document.getElementById("pomTemplateDiv").hidden = true;
        document.getElementById("applicationTemplateDiv").hidden = true;
        document.getElementById("modelTemplateDiv").hidden = true;
        document.getElementById("serviceTemplateDiv").hidden = true;
    }

    function generatorSpringBootPop() {
        $('#generatorSpringBootPop').modal('toggle')
    }


    function generatorSpringBootView() {
        let packagePath = document.getElementById("packagePath").value;
        let artifact = document.getElementById("artifact").value;
        let trimPrefix = document.getElementById("trimPrefix").value;
        let addPrefix = document.getElementById("addPrefix").value;
        let addSuffix = document.getElementById("addSuffix").value;
        document.getElementById("codePreview").innerText = artifact;
        let packageDir = packagePath.replaceAll(".", "/");
        let modelNodes = [];
        let serviceNodes = [];
        let controllerNodes = [];
        let repositoryNodes = []
        let project = {packagePath: packagePath, artifact: artifact, packageDir: packageDir};
        let mainNodes = {};
        let data = [
            {
                text: "domain",
                nodes: modelNodes
            },
            {
                text: "repository",
                nodes: repositoryNodes
            },
            {
                text: "service",
                nodes: serviceNodes
            },
            {
                text: "controller",
                nodes: controllerNodes
            },
            {
                text: "go.mod",
                tag: Mustache.render(pomTemplate.getValue(), project)
            },
            {
                text: "config.toml",
                tag: configTemplate
            }

        ];
        let settings = settingsEditor.getValue().split(";");
        let tables = [];
        for (let setting in settings) {
            let sql = settings[setting].trim();
            if (sql === "") {
                continue;
            }
            if (!sql.trim().toUpperCase().startsWith("CREATE")) {
                continue;
            }
            let tableDefine = getFields(sql, trimPrefix, addPrefix, addSuffix);
            tableDefine.artifact = artifact;
            tableDefine.application = upperCamel(artifact);
            tableDefine.packagePath = packagePath;
            tableDefine.packageDir = packageDir
            let index = tableDefine
            let value = repositoryTemplate.getValue();
            let render = Mustache.render(value, index);
            repositoryNodes.push({text: index.modelName + "_repository.go", tag: render})

            value = controllerTemplate.getValue();
            render = Mustache.render(value, index);
            controllerNodes.push({text: index.modelName + "_controller.go", tag: render})

            value = serviceTemplate.getValue();
            render = Mustache.render(value, index);

            serviceNodes.push({text: index.modelName + "_service.go", tag: render})

            value = modelTemplate.getValue();
            render = Mustache.render(value, index);
            modelNodes.push({text: index.modelName + ".go", tag: render})

            value = queryTemplate.getValue();
            render = Mustache.render(value, index);
            modelNodes.push({text: index.modelName + "_example.go", tag: render})
            tables.push(index);
        }
        project.tables = tables;
        mainNodes = {
            text: "main.go",
            tag: Mustache.render(applicationTemplate.getValue(), project)
        }
        data.push(mainNodes);
        $('#treeview').treeview({
            data: data,
            onNodeSelected: function (event, node) {
                loadTreeTemplateEditor(node.tag)
            },
        });
        setTimeout(function () {
            $('#treeview').treeview('expandAll', {});
            loadTreeTemplateEditor(modelNodes[0].tag)
        }, 100);
        $('#generatorSpringBootView').modal('toggle');
        // generatorSpringBootPop();
    }

    function processType(filed) {
        var type = filed["propertyType"];
        filed["isInt8"] = false;
        filed["isInt16"] = false;
        filed["isInt32"] = false;
        filed["isInt64"] = false;
        filed["isFloat32"] = false;
        filed["isFloat64"] = false;
        filed["isString"] = false;
        filed["isBoolean"] = false;
        if (type == "string") {
            filed["isString"] = true
        } else if (type == "int8") {
            filed["isInt8"] = true
        } else if (type == "int16") {
            filed["isInt16"] = true
        } else if (type == "int32") {
            filed["isInt32"] = true
        } else if (type == "int64") {
            filed["isInt64"] = true
        } else if (type == "float32") {
            filed["isFloat32"] = true
        } else if (type == "float64") {
            filed["isFloat64"] = true
        } else if (type == "int64") {
            filed["isInt64"] = true
        } else if (type == "byte") {
            filed["isByte"] = true
        } else if (type == "bit") {
            filed["isBoolean"] = true
        } else {
            filed["isString"] = true
        }
    }

    function getType(jdbcType) {
        jdbcType = jdbcType.toUpperCase()
        if (jdbcType == "CHAR" || jdbcType == "VARCHAR" || jdbcType == "TEXT" || jdbcType == "LONGTEXT"
            || jdbcType == "LONGVARCHAR" || jdbcType == "VARCHAR2" || jdbcType == "JSON"
            || jdbcType == "SET" || jdbcType == "ENUM" || jdbcType == "NUMERIC") {
            return "string";
        }

        if (jdbcType == "INT" || jdbcType == "INT UNSIGNED" || jdbcType == "INTEGER" || jdbcType == "MEDIUMINT UNSIGNED") {
            return "int32";
        }

        if (jdbcType == "SMALLINT" || jdbcType == "SMALLINT UNSIGNED") {
            return "int16";
        }

        if (jdbcType == "TINYINT" || jdbcType == "TINYINT UNSIGNED") {
            return "int8";
        }

        if (jdbcType == "DATETIME" || jdbcType == "TIMESTAMP"
            || jdbcType == "DATE" || jdbcType == "YEAR" || jdbcType == "TIME") {
            return "string";
        }

        if (jdbcType == "BIGINT" || jdbcType == "BIGINT UNSIGNED") {
            return "int64";
        }

        if (jdbcType == "DOUBLE" || jdbcType == "DOUBLE UNSIGNED") {
            return "float64";
        }

        if (jdbcType == "DECIMAL" || jdbcType == "DECIMAL UNSIGNED") {
            return "float64";
        }

        if (jdbcType == "FLOAT" || jdbcType == "FLOAT UNSIGNED") {
            return "float32";
        }

        if (jdbcType == "BYTE" || jdbcType == "BYTE UNSIGNED") {
            return "byte";
        }

        if (jdbcType == "BINARY" || jdbcType == "GEOMETRY") {
            return "[]byte";
        }

        if (jdbcType == "BIT") {
            return "bool";
        }

        return "string";
    }

    let keywords = [
        "import",
        "package",
        "chan",
        "const",
        "func",
        "interface",
        "map",
        "struct",
        "type",
        "var",
        "break",
        "case",
        "continue",
        "default",
        "defer",
        "else",
        "fallthrough",
        "for",
        "go",
        "if",
        "range",
        "return",
        "select",
        "switch"
    ];

    function processFields(fields) {
        for (let j = 0; j < fields.length; j++) {
            let field = fields[j]
            field["name"] = toLine(field["columnName"]);
            field["upperName"] = upperCamel(field["fieldName"]);
            if (!field["lowerName"]) {
                field["lowerName"] = lowerCamel(field["fieldName"]);
            }
            field["propertyType"] = getType(field["columnType"]);
            processType(field)
            field["hasNext"] = j !== (fields.length - 1);
            field["remarks"] = field["columnComment"];
            if (field["comment"] === "") {
                field["remarks"] = undefined
            }
            if (field["remarks"] === "") {
                field["remarks"] = undefined
            }
        }
    }
</script>
</body>
</html>
